/**
 * Vulnerability Baseline Schema Definition
 *
 * This is the SINGLE SOURCE OF TRUTH for the vulnerability baseline structure.
 * The JSON schema is auto-generated from this Zod definition.
 *
 * To regenerate JSON schema: pnpm run generate:schemas
 */

import { z } from 'zod';

// Vulnerability severity levels
export const severitySchema = z.enum(['critical', 'high', 'moderate', 'low']);

// Individual vulnerability
export const vulnerabilitySchema = z.object({
  id: z.string().describe('Advisory ID (e.g., GHSA-xxxx-xxxx-xxxx)'),
  cve: z.string().regex(/^CVE-\d{4}-\d+$/).optional().describe('CVE identifier if available'),
  module: z.string().describe('Affected npm package name'),
  severity: severitySchema,
  cvss_score: z.number().min(0).max(10).optional().describe('CVSS score (0-10)'),
  cvss_vector: z.string().optional().describe('CVSS vector string'),
  vulnerable_version: z.string().optional().describe('Affected version range'),
  patched_version: z.string().optional().describe('Version with fix available'),
  title: z.string().optional().describe('Vulnerability title/summary'),
  cwe: z.array(z.string()).optional().describe('CWE identifiers'),
  paths: z.array(z.string()).optional().describe('Dependency paths to vulnerable package'),
  is_dev_dependency: z.boolean().optional().describe('Whether in dev dependencies only'),
  remediation: z.object({
    action: z.enum(['update', 'review', 'waiver', 'ignore']).optional(),
    target: z.string().optional().describe('Target version for update'),
    notes: z.string().optional(),
    owner: z.string().optional(),
    sla_deadline: z.string().datetime().optional(),
  }).optional(),
});

// Scan tool definition
export const scanToolSchema = z.object({
  name: z.string().describe('Tool name (e.g., pnpm audit, snyk)'),
  version: z.string().optional(),
  last_run: z.string().datetime().optional(),
  notes: z.string().optional(),
});

// Vulnerability counts
export const vulnerabilityCountsSchema = z.object({
  critical: z.number().int().min(0),
  high: z.number().int().min(0),
  moderate: z.number().int().min(0).optional(),
  low: z.number().int().min(0).optional(),
  total: z.number().int().min(0),
});

// History entry
export const historyEntrySchema = z.object({
  date: z.string().datetime(),
  vulnerabilities: z.number().int().min(0),
  notes: z.string().optional(),
});

// Scan result entry - flexible structure for different scan tools
export const scanResultSchema = z.object({
  status: z.enum(['pass', 'vulnerabilities_found', 'not_run_locally', 'error']).optional(),
  exit_code: z.number().int().optional(),
  vulnerabilities_count: z.number().int().min(0).optional(),
  result: z.string().optional(),
  notes: z.string().optional(),
  breakdown: z.object({
    critical: z.number().int().min(0).optional(),
    high: z.number().int().min(0).optional(),
    moderate: z.number().int().min(0).optional(),
    low: z.number().int().min(0).optional(),
  }).optional(),
  metadata: z.object({
    dependencies: z.number().int().optional(),
    devDependencies: z.number().int().optional(),
    totalDependencies: z.number().int().optional(),
  }).passthrough().optional(),
}).passthrough();

// Package.json changes for remediation
export const packageJsonChangesSchema = z.object({
  file: z.string().optional(),
  section_added: z.string().optional(),
  overrides: z.record(z.string(), z.string()).optional(),
}).passthrough();

// Main vulnerability baseline schema
export const vulnerabilityBaselineSchema = z.object({
  $schema: z.string().optional().describe('Reference to JSON Schema file'),
  version: z.string().regex(/^\d+\.\d+\.\d+$/).describe('Schema version (semver)'),
  generated_at: z.string().datetime().describe('ISO 8601 timestamp'),

  scan_tools: z.array(scanToolSchema).optional(),

  summary: z.object({
    total_dependencies: z.number().int().min(0).optional(),
    direct_dependencies: z.number().int().min(0).optional(),
    transitive_dependencies: z.number().int().min(0).optional(),
    vulnerabilities: vulnerabilityCountsSchema,
    kpi_status: z.object({
      zero_critical: z.boolean().optional(),
      zero_high: z.boolean().optional(),
      zero_moderate: z.boolean().optional(),
      zero_low: z.boolean().optional(),
      baseline_documented: z.boolean().optional(),
    }).optional(),
  }),

  vulnerabilities: z.array(vulnerabilitySchema).optional(),

  waivers: z.array(z.object({
    vulnerability_id: z.string(),
    reason: z.string(),
    approved_by: z.string(),
    approved_at: z.string().datetime().optional(),
    expires_at: z.string().datetime().optional(),
  })).optional(),

  accepted_risks: z.array(z.object({
    id: z.string(),
    description: z.string(),
    accepted_by: z.string().optional(),
    accepted_at: z.string().datetime().optional(),
    review_date: z.string().datetime().optional(),
  })).optional(),

  remediation_applied: z.object({
    date: z.string().datetime().optional(),
    method: z.string().optional(),
    vulnerabilities_fixed: z.array(z.object({
      id: z.string(),
      cve: z.string().optional(),
      module: z.string(),
      severity: z.string(),
      fix_applied: z.string().optional(),
      title: z.string().optional(),
    })).optional(),
    package_json_changes: packageJsonChangesSchema.optional(),
  }).optional(),

  // Zod v4: record requires explicit key and value types
  scan_results: z.record(z.string(), scanResultSchema),

  compliance: z.object({
    sla_compliance: z.object({
      critical_within_24h: z.boolean().optional(),
      high_within_7d: z.boolean().optional(),
      medium_within_30d: z.boolean().optional(),
      low_within_90d: z.boolean().optional(),
    }).optional(),
    kpi_targets_met: z.object({
      zero_critical: z.boolean().optional(),
      zero_high: z.boolean().optional(),
      zero_moderate: z.boolean().optional(),
      zero_low: z.boolean().optional(),
    }).optional(),
    last_audit: z.string().datetime().optional(),
    next_audit: z.string().datetime().optional(),
  }).optional(),

  metrics: z.object({
    mean_time_to_detect_hours: z.number().nullable().optional(),
    mean_time_to_remediate_hours: z.number().nullable().optional(),
    vulnerabilities_this_month: z.number().int().min(0).optional(),
    vulnerabilities_remediated_this_month: z.number().int().min(0).optional(),
    waiver_count: z.number().int().min(0).optional(),
  }).optional(),

  history: z.array(historyEntrySchema).optional(),
  notes: z.array(z.string()).optional(),
});

// Export TypeScript type inferred from Zod schema
export type VulnerabilityBaseline = z.infer<typeof vulnerabilityBaselineSchema>;
export type Vulnerability = z.infer<typeof vulnerabilitySchema>;
export type Severity = z.infer<typeof severitySchema>;
export type ScanResult = z.infer<typeof scanResultSchema>;
