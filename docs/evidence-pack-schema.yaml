# =============================================================================
# Evidence Pack Schema v1.0
# =============================================================================
# This schema defines the required structure for task completion evidence.
# All Tier A tasks must have a conforming evidence pack before sign-off.
# =============================================================================

$schema: 'http://json-schema.org/draft-07/schema#'
$id: 'https://intelliflow-crm.dev/schemas/evidence-pack.schema.json'
title: 'Evidence Pack'
description: 'Schema for task completion evidence pack'
type: object

required:
  - task_id
  - spec_link
  - plan_link
  - validation_runs
  - artifacts
  - audit_result
  - commit_ref

properties:
  task_id:
    type: string
    description: 'Task ID from Sprint_plan.csv'
    pattern: '^(IFC|ENV|AI-SETUP|EXC|AUTOMATION|PLAN-FIX)-[A-Z0-9-]+$'
    examples:
      - 'ENV-001-AI'
      - 'IFC-000'
      - 'EXC-SEC-001'

  spec_link:
    type: string
    description: 'Path to specification document'
    pattern: "^.specify/specifications/.*\\.md$"
    examples:
      - '.specify/specifications/ENV-001-AI.md'

  plan_link:
    type: string
    description: 'Reference to Sprint_plan.csv row or section'
    examples:
      - 'Sprint_plan.csv row 6'
      - 'Sprint_plan.csv:ENV-001-AI'

  validation_runs:
    type: array
    description: 'List of validation run results'
    minItems: 1
    items:
      type: object
      required:
        - id
        - timestamp
        - status
      properties:
        id:
          type: string
          description: 'Unique run identifier'
          examples:
            - 'run-001'
            - 'ci-job-123'
        timestamp:
          type: string
          format: date-time
          description: 'ISO 8601 timestamp of run'
        status:
          type: string
          enum:
            - passed
            - failed
            - skipped
            - manual_override
        log:
          type: string
          description: 'Path to validation log file'
        stdout_hash:
          type: string
          description: 'SHA256 hash of stdout for reproducibility'
          pattern: '^[a-f0-9]{64}$'
        duration_ms:
          type: integer
          description: 'Run duration in milliseconds'

  tests:
    type: array
    description: 'List of test results'
    items:
      type: object
      required:
        - name
        - status
      properties:
        name:
          type: string
          description: 'Test or gate name'
          examples:
            - 'build'
            - 'typecheck'
            - 'unit'
        run_id:
          type: string
          description: 'CI run or job ID'
        status:
          type: string
          enum:
            - passed
            - failed
            - skipped
        coverage:
          type: number
          description: 'Test coverage percentage (0-100)'
          minimum: 0
          maximum: 100

  artifacts:
    type: array
    description: 'List of created artifacts with integrity hashes'
    minItems: 1
    items:
      type: object
      required:
        - path
        - sha256
      properties:
        path:
          type: string
          description: 'Relative path to artifact'
        sha256:
          type: string
          description: 'SHA256 hash of artifact contents'
          pattern: '^[a-f0-9]{64}$'
        created_at:
          type: string
          format: date-time
          description: 'Artifact creation timestamp'
        size_bytes:
          type: integer
          description: 'File size in bytes'

  audit_result:
    oneOf:
      - type: string
        enum:
          - passed
          - failed
          - not_required
      - type: object
        required:
          - status
          - auditor
        properties:
          status:
            type: string
            enum:
              - passed
              - passed_with_notes
              - failed
          auditor:
            type: string
            description: 'Person who performed audit'
          notes:
            type: string
            description: 'Audit notes or findings'
          timestamp:
            type: string
            format: date-time

  waiver:
    type: object
    description: 'Waiver details if audit not fully passed'
    properties:
      approved_by:
        type: string
        description: 'Person who approved waiver'
      reason:
        type: string
        description: 'Reason for waiver'
      expiry:
        type: string
        format: date
        description: 'Waiver expiry date'
      conditions:
        type: array
        items:
          type: string
        description: 'Conditions attached to waiver'

  pr_ref:
    type: string
    description: 'Pull request reference'
    pattern: '^#?[0-9]+$'
    examples:
      - '#42'
      - '123'

  commit_ref:
    type: string
    description: 'Git commit SHA (short or full)'
    pattern: '^[a-f0-9]{7,40}$'
    examples:
      - 'abc1234'
      - 'abc1234567890def1234567890abc1234567890ab'

  kpis:
    type: array
    description: 'KPI measurements from task'
    items:
      type: object
      required:
        - name
        - target
        - actual
        - met
      properties:
        name:
          type: string
          description: 'KPI name from Sprint_plan.csv'
        target:
          type: string
          description: 'Target value'
        actual:
          type: string
          description: 'Actual measured value'
        met:
          type: boolean
          description: 'Whether KPI was met'

  blockers:
    type: array
    description: 'Blockers encountered during task'
    items:
      type: object
      required:
        - id
        - description
        - raised_at
      properties:
        id:
          type: string
          description: 'Blocker identifier'
        description:
          type: string
        raised_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
        resolution:
          type: string

  metadata:
    type: object
    description: 'Additional metadata'
    properties:
      schema_version:
        type: string
        const: '1.0.0'
      generated_at:
        type: string
        format: date-time
      generator:
        type: string
        description: 'Tool that generated this evidence pack'

# =============================================================================
# Examples
# =============================================================================

examples:
  - task_id: 'ENV-001-AI'
    spec_link: '.specify/specifications/ENV-001-AI.md'
    plan_link: 'Sprint_plan.csv row 6'
    validation_runs:
      - id: 'run-001'
        timestamp: '2025-12-15T10:30:00Z'
        status: 'passed'
        log: 'artifacts/logs/ENV-001-AI-validation.log'
        duration_ms: 45000
    tests:
      - name: 'build'
        run_id: 'ci-123'
        status: 'passed'
      - name: 'typecheck'
        run_id: 'ci-123'
        status: 'passed'
      - name: 'turbo_validate'
        run_id: 'ci-123'
        status: 'passed'
    artifacts:
      - path: 'turbo.json'
        sha256: 'abc123def456789012345678901234567890123456789012345678901234'
        created_at: '2025-12-15T10:00:00Z'
      - path: 'pnpm-workspace.yaml'
        sha256: 'def456abc789012345678901234567890123456789012345678901234567'
        created_at: '2025-12-15T10:00:00Z'
    audit_result: 'passed'
    pr_ref: '#42'
    commit_ref: 'abc1234'
    kpis:
      - name: 'Setup time'
        target: '<10 minutes'
        actual: '8 minutes'
        met: true
      - name: 'Manual steps'
        target: '0'
        actual: '0'
        met: true
    metadata:
      schema_version: '1.0.0'
      generated_at: '2025-12-15T11:00:00Z'
      generator: 'plan-linter/evidence-generator'
