#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# IntelliFlow CRM Commit Message Validation
# Enforces conventional commits format

echo "üìù Validating commit message..."

# Get the commit message file path
COMMIT_MSG_FILE=$1

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Conventional commit pattern
# Format: type(scope?): description
# Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,100}"

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
  echo "‚ùå Invalid commit message format!"
  echo ""
  echo "Commit message must follow Conventional Commits:"
  echo "  type(scope?): description"
  echo ""
  echo "Valid types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
  echo ""
  echo "Examples:"
  echo "  feat: add user authentication"
  echo "  fix(api): resolve CORS issue"
  echo "  docs: update README with setup instructions"
  echo "  refactor(domain): simplify lead scoring logic"
  echo ""
  echo "Your message: $COMMIT_MSG"
  exit 1
fi

# Check message length
MSG_LENGTH=$(echo "$COMMIT_MSG" | head -n1 | wc -c)
if [ "$MSG_LENGTH" -gt 100 ]; then
  echo "‚ö†Ô∏è  Warning: Commit message subject is too long (${MSG_LENGTH} chars, max 100)"
fi

echo "‚úÖ Commit message validated!"
