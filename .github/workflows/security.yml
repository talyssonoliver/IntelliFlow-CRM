name: Security Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  trivy-scan:
    name: Trivy Container & Filesystem Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: infra/security/trivy.yaml
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy vulnerability scanner (table output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: infra/security/trivy.yaml
          format: 'table'
          output: 'artifacts/reports/trivy-scan-${{ github.run_number }}.txt'

      - name: Upload Trivy scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results
          path: |
            trivy-results.sarif
            artifacts/reports/trivy-scan-*.txt
          retention-days: 30

  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'intelliflow-crm'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --propertyfile infra/security/dependency-check.yaml
            --out artifacts/reports/dependency-check

      - name: Upload Dependency-Check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-results
          path: artifacts/reports/dependency-check
          retention-days: 30

      - name: Upload Dependency-Check SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: artifacts/reports/dependency-check/dependency-check-report.sarif

  npm-audit:
    name: npm/pnpm Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Run pnpm audit
        run: |
          pnpm audit --json > artifacts/reports/pnpm-audit-${{ github.run_number }}.json || true
          pnpm audit --audit-level=moderate

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pnpm-audit-results
          path: artifacts/reports/pnpm-audit-*.json
          retention-days: 30

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:${{ matrix.language }}'

  secret-scanning:
    name: Secret Scanning with GitLeaks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Upload Gitleaks results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  security-baseline-validation:
    name: Validate Security Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate security baseline
        run: |
          echo "Validating security baseline configuration..."

          # Check required security files exist
          required_files=(
            "SECURITY.md"
            ".github/CODEOWNERS"
            "infra/security/trivy.yaml"
            "infra/security/dependency-check.yaml"
            "artifacts/misc/security-baseline.json"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "ERROR: Missing required security files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "All required security files present"

          # Validate security baseline JSON
          if ! jq empty artifacts/misc/security-baseline.json 2>/dev/null; then
            echo "ERROR: security-baseline.json is not valid JSON"
            exit 1
          fi

          echo "Security baseline validation passed"

      - name: Check security policy compliance
        run: |
          # Verify SECURITY.md contains required sections
          required_sections=(
            "Reporting a Vulnerability"
            "Supported Versions"
            "Security Update Policy"
          )

          for section in "${required_sections[@]}"; do
            if ! grep -q "$section" SECURITY.md; then
              echo "ERROR: SECURITY.md missing section: $section"
              exit 1
            fi
          done

          echo "SECURITY.md compliance check passed"

  docker-scan:
    name: Docker Image Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'docker')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images for scanning
        run: |
          if [ -f "infra/docker/Dockerfile.api" ]; then
            docker build -t intelliflow-crm-api:scan -f infra/docker/Dockerfile.api .
          fi
          if [ -f "infra/docker/Dockerfile.web" ]; then
            docker build -t intelliflow-crm-web:scan -f infra/docker/Dockerfile.web .
          fi

      - name: Scan Docker images with Trivy
        uses: aquasecurity/trivy-action@master
        if: hashFiles('infra/docker/Dockerfile.*') != ''
        with:
          scan-type: 'image'
          image-ref: 'intelliflow-crm-api:scan'
          trivy-config: infra/security/trivy.yaml
          format: 'sarif'
          output: 'trivy-docker-results.sarif'

      - name: Upload Docker scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-docker-results.sarif') != ''
        with:
          sarif_file: 'trivy-docker-results.sarif'

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan, dependency-check, npm-audit, secret-scanning, security-baseline-validation]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate security summary
        run: |
          echo "# Security Scan Summary - Run #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Scan | ${{ needs.trivy-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm/pnpm Audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Baseline Validation | ${{ needs.security-baseline-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review security findings in the Security tab" >> $GITHUB_STEP_SUMMARY
          echo "- Check artifact uploads for detailed reports" >> $GITHUB_STEP_SUMMARY
          echo "- Address any HIGH or CRITICAL vulnerabilities immediately" >> $GITHUB_STEP_SUMMARY

      - name: Fail on critical issues
        if: |
          needs.trivy-scan.result == 'failure' ||
          needs.secret-scanning.result == 'failure' ||
          needs.security-baseline-validation.result == 'failure'
        run: |
          echo "Critical security issues detected!"
          exit 1
