# =============================================================================
# IntelliFlow CRM - Governance Metrics Pipeline
# =============================================================================
# Regenerates all governance artifacts on schedule and on-demand:
# - Performance benchmarks
# - Technical debt analysis
# - Test execution metrics
# - Security mitigation tracking
#
# Artifacts are committed back to the repository for tracking.
# =============================================================================

name: Governance Metrics

on:
  schedule:
    # Run weekly on Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Regenerate all metrics (even if unchanged)'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [main]
    paths:
      - 'packages/**/*.ts'
      - 'apps/**/*.ts'
      - 'docs/debt-ledger.yaml'

concurrency:
  group: governance-metrics-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run performance benchmarks
        run: |
          npx tsx artifacts/misc/architecture-spike/performance-test.ts
          echo "Benchmark completed at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmarks
          path: artifacts/benchmarks/performance-benchmark.json
          retention-days: 90

  technical-debt:
    name: Technical Debt & Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run knip for dead code
        run: |
          pnpm run quality:deadcode:json || true

      - name: Generate code-analysis/latest.json (UI format)
        run: |
          node -e "
          const fs = require('fs');
          const yaml = require('js-yaml');

          const ledgerPath = 'docs/debt-ledger.yaml';
          const outputPath = 'artifacts/reports/code-analysis/latest.json';

          fs.mkdirSync('artifacts/reports/code-analysis', { recursive: true });

          // Initialize output structure matching UI expectations
          const output = {
            timestamp: new Date().toISOString(),
            debt: { success: false, data: null, summary: null },
            sonarqube: { success: false, data: { available: false }, summary: null }
          };

          // Parse debt ledger
          if (fs.existsSync(ledgerPath)) {
            try {
              const ledger = yaml.load(fs.readFileSync(ledgerPath, 'utf8'));
              const items = ledger.items || [];

              const bySeverity = { critical: 0, high: 0, medium: 0, low: 0 };
              const byStatus = { open: 0, inProgress: 0, resolved: 0 };
              let overdueItems = [];

              items.forEach(item => {
                const sev = (item.priority || 'medium').toLowerCase();
                if (bySeverity[sev] !== undefined) bySeverity[sev]++;

                const status = (item.status || 'open').toLowerCase().replace('-', '');
                if (status === 'open') byStatus.open++;
                else if (status === 'inprogress') byStatus.inProgress++;
                else if (status === 'resolved' || status === 'done') byStatus.resolved++;

                if (item.due_date && new Date(item.due_date) < new Date()) {
                  overdueItems.push(item);
                }
              });

              // Health score: 100 = no debt, lower = more debt
              const criticalWeight = bySeverity.critical * 20;
              const highWeight = bySeverity.high * 10;
              const mediumWeight = bySeverity.medium * 5;
              const lowWeight = bySeverity.low * 1;
              const totalWeight = criticalWeight + highWeight + mediumWeight + lowWeight;
              const healthScore = Math.max(0, Math.min(100, 100 - totalWeight));

              output.debt = {
                success: true,
                data: {
                  total: items.length,
                  bySeverity,
                  byStatus,
                  overdueItems,
                  expiringSoon: [],
                  healthScore
                },
                summary: {
                  total: items.length,
                  critical: bySeverity.critical,
                  overdue: overdueItems.length,
                  healthScore
                }
              };

              console.log('Debt analysis:', output.debt.summary);
            } catch (e) {
              console.error('Failed to parse debt ledger:', e.message);
            }
          }

          // Check SonarQube (placeholder if not running)
          output.sonarqube = {
            success: true,
            data: {
              available: false,
              message: 'SonarQube metrics collected during sonar.yml workflow'
            },
            summary: null
          };

          fs.writeFileSync(outputPath, JSON.stringify(output, null, 2));
          console.log('Code analysis output written to:', outputPath);
          "

      - name: Upload debt artifacts
        uses: actions/upload-artifact@v4
        with:
          name: technical-debt
          path: |
            artifacts/reports/code-analysis/latest.json
            artifacts/reports/code-analysis/knip-report.json
          retention-days: 90

  test-metrics:
    name: Test Coverage & Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        id: tests
        run: |
          START=$(date +%s)
          pnpm run test:coverage 2>&1 | tee test-output.log || true
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

      - name: Add TDD metadata to coverage report
        run: |
          node -e "
          const fs = require('fs');

          const coveragePath = 'artifacts/coverage/coverage-summary.json';
          const timestamp = new Date().toISOString();
          const duration = '${{ steps.tests.outputs.duration }}';

          if (fs.existsSync(coveragePath)) {
            try {
              const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));

              // Add TDD-friendly metadata
              coverage.meta = {
                lastRunAt: timestamp,
                duration: parseInt(duration) || 0,
                source: 'ci',
                workflow: 'governance-metrics',
                status: 'passed',
                thresholdsMet: true
              };

              // Calculate overall score
              if (coverage.total) {
                const t = coverage.total;
                coverage.meta.overall = Math.round(
                  (t.lines.pct + t.branches.pct + t.functions.pct + t.statements.pct) / 4
                );
                coverage.meta.thresholdsMet = coverage.meta.overall >= 80;
                coverage.meta.status = coverage.meta.thresholdsMet ? 'passed' : 'partial';
              }

              fs.writeFileSync(coveragePath, JSON.stringify(coverage, null, 2));
              console.log('Coverage metadata added:', coverage.meta);
            } catch (e) {
              console.error('Failed to update coverage:', e.message);
            }
          }

          // Also generate execution log
          const log = [
            '# Test Execution Time Log',
            '# Generated: ' + timestamp,
            '# Workflow: governance-metrics',
            '',
            '## Execution Metrics',
            '- Duration: ' + duration + 's',
            '- Source: CI (governance-metrics workflow)',
            '',
            '## Command',
            'pnpm test:coverage',
            '',
            '---',
            'Log generated by governance-metrics workflow'
          ].join('\\n');

          fs.mkdirSync('artifacts/logs', { recursive: true });
          fs.writeFileSync('artifacts/logs/test-execution-time.log', log);
          "

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-metrics
          path: |
            artifacts/coverage/
            artifacts/logs/test-execution-time.log
          retention-days: 90

  security-tracking:
    name: Security Mitigation Tracking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          pnpm audit --json > artifacts/reports/security/pnpm-audit-latest.json 2>&1 || true
          node scripts/pnpm-audit-report.js || true

      - name: Analyze mitigation backlog
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          const backlogPath = 'artifacts/logs/mitigation-backlog.csv';
          const outputPath = 'artifacts/reports/security/mitigation-summary.json';

          if (fs.existsSync(backlogPath)) {
            const content = fs.readFileSync(backlogPath, 'utf8');
            const lines = content.trim().split('\n').slice(1); // Skip header

            const summary = {
              timestamp: new Date().toISOString(),
              total: lines.length,
              by_priority: { Critical: 0, High: 0, Medium: 0, Low: 0 },
              by_status: { Planned: 0, 'In Progress': 0, Done: 0 },
              by_category: {}
            };

            lines.forEach(line => {
              const cols = line.split(',');
              if (cols.length >= 6) {
                const priority = cols[3];
                const category = cols[4];
                const status = cols[5];

                if (summary.by_priority[priority] !== undefined) {
                  summary.by_priority[priority]++;
                }
                summary.by_status[status] = (summary.by_status[status] || 0) + 1;
                summary.by_category[category] = (summary.by_category[category] || 0) + 1;
              }
            });

            fs.mkdirSync(path.dirname(outputPath), { recursive: true });
            fs.writeFileSync(outputPath, JSON.stringify(summary, null, 2));
            console.log('Mitigation summary:', summary);
          }
          "

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-tracking
          path: |
            artifacts/reports/security/pnpm-audit-latest.json
            artifacts/reports/security/mitigation-summary.json
          retention-days: 90

  commit-artifacts:
    name: Commit Updated Artifacts
    runs-on: ubuntu-latest
    needs: [performance-benchmarks, technical-debt, test-metrics, security-tracking]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Copy artifacts to repo
        run: |
          # Performance benchmarks
          if [ -f "downloaded-artifacts/performance-benchmarks/performance-benchmark.json" ]; then
            mkdir -p artifacts/benchmarks
            cp downloaded-artifacts/performance-benchmarks/performance-benchmark.json artifacts/benchmarks/
          fi

          # Technical debt / code analysis
          if [ -d "downloaded-artifacts/technical-debt" ]; then
            mkdir -p artifacts/reports/code-analysis
            cp -r downloaded-artifacts/technical-debt/* artifacts/reports/code-analysis/ 2>/dev/null || true
          fi

          # Test coverage
          if [ -d "downloaded-artifacts/test-metrics/coverage" ]; then
            mkdir -p artifacts/coverage
            cp -r downloaded-artifacts/test-metrics/coverage/* artifacts/coverage/ 2>/dev/null || true
          fi
          if [ -f "downloaded-artifacts/test-metrics/test-execution-time.log" ]; then
            mkdir -p artifacts/logs
            cp downloaded-artifacts/test-metrics/test-execution-time.log artifacts/logs/
          fi

          # Security tracking
          if [ -d "downloaded-artifacts/security-tracking" ]; then
            mkdir -p artifacts/reports/security
            cp -r downloaded-artifacts/security-tracking/* artifacts/reports/security/ 2>/dev/null || true
          fi

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add artifacts/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(governance): update metrics artifacts [skip ci]

          - Performance benchmarks regenerated
          - Technical debt analysis updated
          - Test execution metrics refreshed
          - Security mitigation tracking updated

          Generated by governance-metrics workflow"
            git push
          fi

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [performance-benchmarks, technical-debt, test-metrics, security-tracking]
    if: always()
    steps:
      - name: Generate workflow summary
        run: |
          echo "## Governance Metrics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Benchmarks | ${{ needs.performance-benchmarks.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Technical Debt | ${{ needs.technical-debt.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Metrics | ${{ needs.test-metrics.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tracking | ${{ needs.security-tracking.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available for download and will be committed to main." >> $GITHUB_STEP_SUMMARY
