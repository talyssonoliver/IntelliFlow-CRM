name: Artifact Path Linting

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**/*.log'
      - '**/*.html'
      - '**/*.json'
      - '**/*.csv'
      - 'artifacts/**'
      - 'tools/lint/artifact-paths.ts'
      - '.github/workflows/artifact-lint.yml'
  push:
    branches:
      - main
      - develop
  workflow_dispatch: # Allow manual triggering

jobs:
  lint-artifact-paths:
    name: Lint Artifact Paths
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run artifact path linter
        id: lint
        run: |
          echo "Running artifact path linter..."
          pnpm tsx tools/lint/artifact-paths.ts > lint-output.txt 2>&1 || echo "LINT_FAILED=true" >> $GITHUB_ENV
          cat lint-output.txt

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifact-lint-results
          path: lint-output.txt
          retention-days: 30

      - name: Check for violations
        if: env.LINT_FAILED == 'true'
        run: |
          echo "::error::Artifact path violations detected. Please review the lint output above."
          exit 1

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const lintOutput = fs.readFileSync('lint-output.txt', 'utf8');

            const body = `## üîç Artifact Path Linting Failed

            The artifact path linter detected violations in your changes.

            <details>
            <summary>View Details</summary>

            \`\`\`
            ${lintOutput.substring(0, 4000)}
            \`\`\`

            </details>

            ### Common Issues:

            - **Prohibited Location**: Move artifact files to \`artifacts/\` directory
            - **Prohibited Pattern**: Remove files with \`.secret\`, \`.private\`, \`.key\`, \`.pem\` patterns
            - **Invalid Artifact Path**: Place artifacts in correct category (\`logs/\`, \`reports/\`, \`metrics/\`, \`misc/\`)
            - **File Size**: Compress or split files exceeding size limits
            - **Secrets Detected**: Remove any secrets or credentials from files
            - **PII Detected**: Sanitize any personally identifiable information

            ### How to Fix:

            1. Review the violations listed above
            2. Move misplaced files to \`artifacts/\` directory
            3. Remove any prohibited patterns or sensitive data
            4. Run \`pnpm tsx tools/lint/artifact-paths.ts\` locally to verify
            5. Commit and push your changes

            For more information, see:
            - [Artifact Path Conventions](../../docs/architecture/artifact-conventions.md)
            - [Repository Layout](../../docs/architecture/repo-layout.md)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  security-scan:
    name: Scan for Secrets in Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install

      - name: Configure git-secrets
        run: |
          git secrets --install
          git secrets --register-aws
          git secrets --add 'sk-[a-zA-Z0-9]{48,}' # OpenAI keys
          git secrets --add 'ghp_[a-zA-Z0-9]{36,}' # GitHub tokens
          git secrets --add 'AKIA[0-9A-Z]{16}' # AWS keys
          git secrets --add 'postgresql:\/\/[^:]+:[^@]+@' # DB connection strings

      - name: Scan artifacts directory
        if: hashFiles('artifacts/**') != ''
        run: |
          if [ -d "artifacts" ]; then
            git secrets --scan artifacts/ || {
              echo "::error::Secrets detected in artifacts directory!"
              exit 1
            }
          else
            echo "No artifacts directory found, skipping scan"
          fi

      - name: Scan for .env files (except .env.example)
        run: |
          ENV_FILES=$(find . -name ".env*" -not -name ".env.example" -not -path "*/node_modules/*" -not -path "*/.git/*")
          if [ -n "$ENV_FILES" ]; then
            echo "::error::Found .env files that should not be committed:"
            echo "$ENV_FILES"
            exit 1
          fi

  artifact-size-check:
    name: Check Artifact Sizes
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check artifacts directory size
        run: |
          if [ -d "artifacts" ]; then
            ARTIFACTS_SIZE=$(du -sm artifacts | cut -f1)
            echo "Artifacts directory size: ${ARTIFACTS_SIZE}MB"

            if [ $ARTIFACTS_SIZE -gt 100 ]; then
              echo "::warning::Artifacts directory is large (${ARTIFACTS_SIZE}MB). Consider cleanup."
            fi

            if [ $ARTIFACTS_SIZE -gt 500 ]; then
              echo "::error::Artifacts directory is too large (${ARTIFACTS_SIZE}MB). Maximum is 500MB."
              exit 1
            fi
          else
            echo "No artifacts directory found"
          fi

      - name: Check for oversized files
        run: |
          LARGE_FILES=$(find . -type f -size +20M -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "::warning::Found files larger than 20MB:"
            echo "$LARGE_FILES"
          fi

  validate-gitignore:
    name: Validate .gitignore Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if artifacts are ignored
        run: |
          # Create a test file in artifacts
          mkdir -p artifacts/test
          touch artifacts/test/test.log

          # Check if git would ignore it
          if git check-ignore -q artifacts/test/test.log; then
            echo "‚úì artifacts/ directory is properly ignored"
          else
            echo "::error::artifacts/ directory is not in .gitignore!"
            exit 1
          fi

          # Cleanup
          rm -rf artifacts/test

      - name: Check for committed artifacts
        run: |
          COMMITTED_ARTIFACTS=$(git ls-files | grep -E '\.(log|coverage|tsbuildinfo)$' || true)
          if [ -n "$COMMITTED_ARTIFACTS" ]; then
            echo "::error::Found committed artifact files:"
            echo "$COMMITTED_ARTIFACTS"
            echo "These files should be in .gitignore"
            exit 1
          fi

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [lint-artifact-paths, security-scan, artifact-size-check, validate-gitignore]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint-artifact-paths.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.artifact-size-check.result }}" != "success" ] || \
             [ "${{ needs.validate-gitignore.result }}" != "success" ]; then
            echo "::error::One or more artifact validation checks failed"
            exit 1
          fi

          echo "‚úì All artifact validation checks passed"
