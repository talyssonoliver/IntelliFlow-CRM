# IFC-132: Supply Chain Security - SBOM Generation
# This workflow generates a Software Bill of Materials (SBOM) for every build
# and runs dependency audits to ensure supply chain security.
#
# KPIs:
# - 100% builds produce SBOM
# - 0 unsigned/untracked dependency changes merged
#
# References:
# - docs/security/supply-chain.md
# - docs/security/owasp-checklist.md (A06: Vulnerable and Outdated Components)
# - artifacts/misc/security-baseline.json

name: Supply Chain Security - SBOM

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      force_full_scan:
        description: 'Force full dependency scan (slower but comprehensive)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  SBOM_FORMAT: 'cyclonedx-json'  # CycloneDX 1.5 format

jobs:
  # ===========================================
  # Job 1: Generate SBOM using Syft
  # ===========================================
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      sbom_artifact_name: ${{ steps.sbom-name.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify lock file integrity
        id: lockfile-check
        run: |
          echo "Checking pnpm-lock.yaml integrity..."

          # Verify lockfile exists and is not empty
          if [ ! -f "pnpm-lock.yaml" ]; then
            echo "ERROR: pnpm-lock.yaml not found!"
            exit 1
          fi

          # Check lockfile version
          LOCKFILE_VERSION=$(head -1 pnpm-lock.yaml | grep -oP "(?<=lockfileVersion: ')[\d.]+" || echo "unknown")
          echo "Lockfile version: $LOCKFILE_VERSION"

          # Verify dependencies match lockfile (will fail if lockfile needs update)
          pnpm install --frozen-lockfile --ignore-scripts

          echo "lockfile_version=$LOCKFILE_VERSION" >> $GITHUB_OUTPUT
          echo "Lockfile integrity verified"

      - name: Generate unique SBOM name
        id: sbom-name
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          SHORT_SHA=${GITHUB_SHA::8}
          BRANCH_NAME=${GITHUB_REF_NAME//\//-}
          SBOM_NAME="sbom-intelliflow-crm-${BRANCH_NAME}-${SHORT_SHA}-${TIMESTAMP}"
          echo "name=$SBOM_NAME" >> $GITHUB_OUTPUT
          echo "Generated SBOM name: $SBOM_NAME"

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM with Syft (CycloneDX format)
        run: |
          mkdir -p artifacts/sbom

          # Generate SBOM in CycloneDX 1.5 JSON format
          syft dir:. \
            --output cyclonedx-json=artifacts/sbom/${{ steps.sbom-name.outputs.name }}.cyclonedx.json \
            --output spdx-json=artifacts/sbom/${{ steps.sbom-name.outputs.name }}.spdx.json \
            --output table=artifacts/sbom/${{ steps.sbom-name.outputs.name }}.txt

          # Generate human-readable summary
          echo "# SBOM Summary for IntelliFlow CRM" > artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "Commit: ${{ github.sha }}" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "Branch: ${{ github.ref_name }}" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "Workflow Run: ${{ github.run_id }}" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          echo "## Package Count" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md
          PACKAGE_COUNT=$(cat artifacts/sbom/${{ steps.sbom-name.outputs.name }}.cyclonedx.json | jq '.components | length')
          echo "Total components: $PACKAGE_COUNT" >> artifacts/sbom/${{ steps.sbom-name.outputs.name }}.summary.md

          echo "SBOM generated successfully with $PACKAGE_COUNT components"

      - name: Validate SBOM format
        run: |
          # Validate CycloneDX JSON schema
          echo "Validating CycloneDX SBOM format..."
          if ! jq empty artifacts/sbom/${{ steps.sbom-name.outputs.name }}.cyclonedx.json 2>/dev/null; then
            echo "ERROR: Invalid CycloneDX JSON format"
            exit 1
          fi

          # Check required fields
          SPEC_VERSION=$(jq -r '.specVersion' artifacts/sbom/${{ steps.sbom-name.outputs.name }}.cyclonedx.json)
          BOM_FORMAT=$(jq -r '.bomFormat' artifacts/sbom/${{ steps.sbom-name.outputs.name }}.cyclonedx.json)

          echo "CycloneDX Spec Version: $SPEC_VERSION"
          echo "BOM Format: $BOM_FORMAT"

          if [ "$BOM_FORMAT" != "CycloneDX" ]; then
            echo "ERROR: Invalid BOM format"
            exit 1
          fi

          echo "SBOM validation passed"

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.sbom-name.outputs.name }}
          path: |
            artifacts/sbom/*.cyclonedx.json
            artifacts/sbom/*.spdx.json
            artifacts/sbom/*.txt
            artifacts/sbom/*.summary.md
          retention-days: 90
          if-no-files-found: error

      - name: Upload SBOM for release
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-sbom-${{ github.event.release.tag_name }}
          path: |
            artifacts/sbom/*.cyclonedx.json
            artifacts/sbom/*.spdx.json
          retention-days: 365

  # ===========================================
  # Job 2: Dependency Audit
  # ===========================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        run: |
          mkdir -p artifacts/reports/security

          # Run audit and capture output
          pnpm audit --json > artifacts/reports/security/pnpm-audit-${{ github.run_number }}.json 2>&1 || true

          # Parse audit results
          CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' artifacts/reports/security/pnpm-audit-${{ github.run_number }}.json || echo "0")
          HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' artifacts/reports/security/pnpm-audit-${{ github.run_number }}.json || echo "0")
          MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' artifacts/reports/security/pnpm-audit-${{ github.run_number }}.json || echo "0")
          LOW=$(jq -r '.metadata.vulnerabilities.low // 0' artifacts/reports/security/pnpm-audit-${{ github.run_number }}.json || echo "0")

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo "## Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY

      - name: Check vulnerability thresholds
        run: |
          # Per security-baseline.json thresholds
          MAX_CRITICAL=0
          MAX_HIGH=5

          CRITICAL=${{ steps.audit.outputs.critical }}
          HIGH=${{ steps.audit.outputs.high }}

          if [ "$CRITICAL" -gt "$MAX_CRITICAL" ]; then
            echo "ERROR: Critical vulnerabilities ($CRITICAL) exceed threshold ($MAX_CRITICAL)"
            exit 1
          fi

          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            echo "WARNING: High vulnerabilities ($HIGH) exceed threshold ($MAX_HIGH)"
            # Note: This is a warning, not a failure, per security-baseline.json
          fi

          echo "Vulnerability thresholds check passed"

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-${{ github.run_number }}
          path: artifacts/reports/security/pnpm-audit-*.json
          retention-days: 30

  # ===========================================
  # Job 3: License Compliance Check
  # ===========================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run license check
        run: |
          mkdir -p artifacts/reports/security

          # Install license-checker if not already available
          pnpm exec license-checker --json > artifacts/reports/security/licenses-${{ github.run_number }}.json || true

          # Check for forbidden licenses (per security-baseline.json)
          FORBIDDEN_LICENSES="GPL-2.0 GPL-3.0 AGPL-1.0 AGPL-3.0"

          echo "Checking for forbidden licenses..."
          for LICENSE in $FORBIDDEN_LICENSES; do
            COUNT=$(jq -r --arg lic "$LICENSE" '[.[] | select(.licenses == $lic)] | length' artifacts/reports/security/licenses-${{ github.run_number }}.json || echo "0")
            if [ "$COUNT" -gt "0" ]; then
              echo "WARNING: Found $COUNT packages with forbidden license: $LICENSE"
              jq -r --arg lic "$LICENSE" 'to_entries[] | select(.value.licenses == $lic) | .key' artifacts/reports/security/licenses-${{ github.run_number }}.json
            fi
          done

          echo "License check completed"

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report-${{ github.run_number }}
          path: artifacts/reports/security/licenses-*.json
          retention-days: 30

  # ===========================================
  # Job 4: Lockfile Change Detection
  # ===========================================
  lockfile-change-detection:
    name: Lockfile Change Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for lockfile changes
        id: lockfile-changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})

          LOCKFILE_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -q "pnpm-lock.yaml"; then
            LOCKFILE_CHANGED="true"
          fi

          echo "changed=$LOCKFILE_CHANGED" >> $GITHUB_OUTPUT

          if [ "$LOCKFILE_CHANGED" = "true" ]; then
            echo "## Lockfile Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The \`pnpm-lock.yaml\` file has been modified in this PR." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Review Required**: Please verify that dependency changes are intentional and from trusted sources." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Checklist for reviewers:" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] New dependencies are from trusted publishers" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Version updates are intentional" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] No unexpected packages added" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] License compliance verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "No lockfile changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Analyze lockfile diff
        if: steps.lockfile-changes.outputs.changed == 'true'
        run: |
          echo "Analyzing lockfile changes..."

          # Show diff summary (not full diff as it can be very large)
          git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- pnpm-lock.yaml

          # Count additions and deletions
          ADDITIONS=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- pnpm-lock.yaml | grep "^+" | wc -l)
          DELETIONS=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- pnpm-lock.yaml | grep "^-" | wc -l)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lockfile Diff Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: $ADDITIONS" >> $GITHUB_STEP_SUMMARY
          echo "- Lines removed: $DELETIONS" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Job 5: Supply Chain Summary
  # ===========================================
  supply-chain-summary:
    name: Supply Chain Summary
    runs-on: ubuntu-latest
    needs: [generate-sbom, dependency-audit, license-check]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generate summary report
        run: |
          echo "# Supply Chain Security Summary - Run #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.generate-sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## KPI Tracking (IFC-132)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.generate-sbom.result }}" = "success" ]; then
            echo "- [x] SBOM generated for this build" >> $GITHUB_STEP_SUMMARY
          else
            echo "- [ ] SBOM generated for this build (FAILED)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- SBOM Artifact: ${{ needs.generate-sbom.outputs.sbom_artifact_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## References" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Supply Chain Policy](../docs/security/supply-chain.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Baseline](../artifacts/misc/security-baseline.json)" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical jobs failed
        if: needs.generate-sbom.result == 'failure'
        run: |
          echo "ERROR: SBOM generation failed - this violates the 100% SBOM requirement"
          exit 1
