# Secret Rotation Workflow
# Task: IFC-121 - Periodic Secret Rotation
# Created: 2025-12-29

name: Secret Rotation

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      secret_type:
        description: 'Type of secrets to rotate'
        required: true
        type: choice
        options:
          - all
          - database
          - api_keys
          - jwt_keys
          - encryption_keys
      dry_run:
        description: 'Dry run mode (no actual rotation)'
        required: false
        type: boolean
        default: true

env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}

jobs:
  check-rotation-due:
    name: Check Secrets Due for Rotation
    runs-on: ubuntu-latest
    outputs:
      secrets_to_rotate: ${{ steps.check.outputs.secrets }}
      rotation_needed: ${{ steps.check.outputs.needed }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check rotation schedule
        id: check
        run: |
          npx tsx tools/scripts/rotate-secrets.ts check \
            --schedule artifacts/misc/rotation-schedule.yaml \
            --output rotation-check.json

          NEEDED=$(jq -r '.rotation_needed' rotation-check.json)
          SECRETS=$(jq -c '.secrets_due' rotation-check.json)

          echo "needed=$NEEDED" >> $GITHUB_OUTPUT
          echo "secrets=$SECRETS" >> $GITHUB_OUTPUT

  rotate-secrets:
    name: Rotate Secrets
    needs: check-rotation-due
    if: needs.check-rotation-due.outputs.rotation_needed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Import Vault secrets
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          token: ${{ env.VAULT_TOKEN }}
          secrets: |
            secret/data/intelliflow/rotation ROTATION_CONFIG

      - name: Notify rotation start
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ secrets.SLACK_SECURITY_CHANNEL }}
          slack-message: |
            :rotating_light: Secret rotation starting
            Triggered by: ${{ github.event_name }}
            Secrets: ${{ needs.check-rotation-due.outputs.secrets_to_rotate }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Rotate secrets
        id: rotate
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          SECRET_TYPE="${{ github.event.inputs.secret_type || 'all' }}"

          npx tsx tools/scripts/rotate-secrets.ts rotate \
            --type $SECRET_TYPE \
            --schedule artifacts/misc/rotation-schedule.yaml \
            $DRY_RUN_FLAG \
            --output rotation-result.json

          echo "result=$(cat rotation-result.json | jq -c)" >> $GITHUB_OUTPUT

      - name: Validate new secrets
        if: github.event.inputs.dry_run != 'true'
        run: |
          npx tsx tools/scripts/rotate-secrets.ts validate \
            --result rotation-result.json

      - name: Update GitHub secrets
        if: github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_TOKEN }}
          script: |
            const result = JSON.parse('${{ steps.rotate.outputs.result }}');
            for (const secret of result.rotated_secrets) {
              await github.rest.actions.createOrUpdateRepoSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                secret_name: secret.name,
                encrypted_value: secret.encrypted_value
              });
            }

      - name: Notify rotation complete
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ secrets.SLACK_SECURITY_CHANNEL }}
          slack-message: |
            :white_check_mark: Secret rotation completed successfully
            Rotated: ${{ steps.rotate.outputs.result }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify rotation failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: ${{ secrets.SLACK_SECURITY_CHANNEL }}
          slack-message: |
            :x: Secret rotation FAILED
            Check workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  audit-log:
    name: Create Audit Log
    needs: rotate-secrets
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create audit entry
        run: |
          cat >> artifacts/reports/secret-rotation-audit.log << EOF
          ---
          timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          workflow_run: ${{ github.run_id }}
          triggered_by: ${{ github.event_name }}
          status: ${{ needs.rotate-secrets.result }}
          actor: ${{ github.actor }}
          EOF
