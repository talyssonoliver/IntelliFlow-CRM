# IntelliFlow CRM - mTLS Configuration
# IMPLEMENTS: IFC-113 (Secrets Management & Encryption)
#
# This configuration enables mutual TLS (mTLS) for service-to-service
# communication, ensuring both client and server authenticate each other.

# Global mTLS settings
mtls:
  enabled: true
  mode: STRICT  # STRICT, PERMISSIVE, or DISABLED

# TLS version and cipher configuration
tls:
  min_version: "1.2"
  max_version: "1.3"
  cipher_suites:
    # TLS 1.3 cipher suites (automatically selected)
    - TLS_AES_256_GCM_SHA384
    - TLS_CHACHA20_POLY1305_SHA256
    - TLS_AES_128_GCM_SHA256
    # TLS 1.2 cipher suites (ECDHE only for forward secrecy)
    - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
    - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
    - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
    - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
    - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256

  # Elliptic curves for ECDHE
  curves:
    - X25519
    - secp384r1
    - secp256r1

# Certificate Authority configuration
ca:
  # Root CA for IntelliFlow services
  root:
    common_name: "IntelliFlow Root CA"
    organization: "IntelliFlow"
    country: "GB"
    validity_days: 3650  # 10 years
    key_algorithm: "ECDSA"
    key_size: 384  # P-384 curve

  # Intermediate CA for service certificates
  intermediate:
    common_name: "IntelliFlow Services CA"
    organization: "IntelliFlow"
    validity_days: 1825  # 5 years
    key_algorithm: "ECDSA"
    key_size: 384

  # Certificate paths
  paths:
    root_cert: /etc/intelliflow/tls/ca/root-ca.crt
    root_key: /etc/intelliflow/tls/ca/root-ca.key
    intermediate_cert: /etc/intelliflow/tls/ca/intermediate-ca.crt
    intermediate_key: /etc/intelliflow/tls/ca/intermediate-ca.key
    crl: /etc/intelliflow/tls/ca/crl.pem

# Service certificate configuration
services:
  # API server (tRPC)
  api:
    common_name: "intelliflow-api"
    dns_names:
      - api.intelliflow.local
      - localhost
      - api
    ip_addresses:
      - 127.0.0.1
      - "::1"
    validity_days: 365
    key_algorithm: "ECDSA"
    key_size: 256  # P-256 curve
    paths:
      cert: /etc/intelliflow/tls/services/api.crt
      key: /etc/intelliflow/tls/services/api.key

  # Web frontend (Next.js)
  web:
    common_name: "intelliflow-web"
    dns_names:
      - web.intelliflow.local
      - localhost
      - web
    ip_addresses:
      - 127.0.0.1
    validity_days: 365
    key_algorithm: "ECDSA"
    key_size: 256
    paths:
      cert: /etc/intelliflow/tls/services/web.crt
      key: /etc/intelliflow/tls/services/web.key

  # AI Worker
  ai_worker:
    common_name: "intelliflow-ai-worker"
    dns_names:
      - ai-worker.intelliflow.local
      - ai-worker
    validity_days: 365
    key_algorithm: "ECDSA"
    key_size: 256
    paths:
      cert: /etc/intelliflow/tls/services/ai-worker.crt
      key: /etc/intelliflow/tls/services/ai-worker.key

  # Database (Supabase)
  database:
    common_name: "intelliflow-database"
    dns_names:
      - db.intelliflow.local
      - supabase.intelliflow.local
    validity_days: 365
    key_algorithm: "ECDSA"
    key_size: 256
    paths:
      cert: /etc/intelliflow/tls/services/database.crt
      key: /etc/intelliflow/tls/services/database.key

  # Redis cache
  redis:
    common_name: "intelliflow-redis"
    dns_names:
      - redis.intelliflow.local
      - cache.intelliflow.local
    validity_days: 365
    key_algorithm: "ECDSA"
    key_size: 256
    paths:
      cert: /etc/intelliflow/tls/services/redis.crt
      key: /etc/intelliflow/tls/services/redis.key

# Client certificate requirements
client_auth:
  # Services authorized to connect
  allowed_clients:
    - common_name: "intelliflow-api"
      permissions:
        - read:all
        - write:all
    - common_name: "intelliflow-web"
      permissions:
        - read:all
        - write:limited
    - common_name: "intelliflow-ai-worker"
      permissions:
        - read:ai-data
        - write:ai-scores

  # Certificate validation settings
  validation:
    verify_client: true
    verify_depth: 3
    check_crl: true
    check_ocsp: true
    allow_expired: false

# Certificate revocation configuration
revocation:
  crl:
    enabled: true
    update_interval: "1h"
    distribution_points:
      - http://crl.intelliflow.local/crl.pem

  ocsp:
    enabled: true
    responder_url: http://ocsp.intelliflow.local
    signing_cert: /etc/intelliflow/tls/ocsp/ocsp-signer.crt
    signing_key: /etc/intelliflow/tls/ocsp/ocsp-signer.key

# Certificate renewal settings
renewal:
  enabled: true
  threshold_days: 30  # Renew when less than 30 days remain
  auto_renew: true
  notification:
    enabled: true
    webhook: ${CERT_RENEWAL_WEBHOOK:-}
    email: ${CERT_RENEWAL_EMAIL:-}
    days_before:
      - 30
      - 14
      - 7
      - 1

# Environment-specific overrides
environments:
  development:
    mtls:
      mode: PERMISSIVE  # Allow non-mTLS for local development
    tls:
      min_version: "1.2"
    renewal:
      auto_renew: false

  staging:
    mtls:
      mode: STRICT
    renewal:
      threshold_days: 14

  production:
    mtls:
      mode: STRICT
    tls:
      min_version: "1.3"  # TLS 1.3 only in production
    renewal:
      threshold_days: 30
      auto_renew: true

# Kubernetes/container settings
kubernetes:
  enabled: false
  secret_namespace: intelliflow
  secrets:
    ca_cert: intelliflow-ca-cert
    service_certs: intelliflow-service-certs

  # cert-manager integration
  cert_manager:
    enabled: false
    issuer_name: intelliflow-ca-issuer
    issuer_kind: ClusterIssuer

# Monitoring and alerting
monitoring:
  enabled: true
  metrics:
    # Prometheus metrics
    prometheus:
      enabled: true
      port: 9090
      path: /metrics

  alerts:
    certificate_expiry:
      warning_days: 30
      critical_days: 7
    revocation_check_failure:
      severity: high
    handshake_failures:
      threshold: 100
      window: "5m"

# Logging
logging:
  level: info
  format: json
  include_fields:
    - timestamp
    - service
    - peer_cn
    - cipher_suite
    - tls_version
    - validation_result

  # Audit specific TLS events
  audit:
    enabled: true
    events:
      - HANDSHAKE_SUCCESS
      - HANDSHAKE_FAILURE
      - CERTIFICATE_VALIDATION_FAILURE
      - CRL_CHECK_FAILURE
      - OCSP_CHECK_FAILURE
