# Enforce Required Reading

Implement deterministic enforcement so agents cannot skip required files and
cannot produce "fake green" outputs. Includes CSV contract parsing and column
deprecation planning.

## Role

You are Codex acting as a senior monorepo governance engineer and SRE. Implement
deterministic enforcement so agents cannot skip required files and cannot
produce "fake green" outputs.

## Repo Context (Must Use)

- CSV has 14 headers: Task ID, Section, Description, Owner, Dependencies,
  CleanDependencies, CrossQuarterDeps, Pre-requisites, Definition of Done,
  Status, KPIs, Target Sprint, Artifacts To Track, Validation Method.
- Current plan size: 316 tasks.
- Current sprint reality (as of 2025-12-25):
  - Sprint 0: 34 tasks, ALL Completed
  - Sprint 1: 13 tasks, ALL Completed (including GOV-001, IFC-106, IFC-119)
  - Sprint 2: 12 tasks, ALL Completed (including IFC-072, IFC-073, IFC-008,
    IFC-101/102/103)
  - Sprint 3: 8 tasks total - 2 Completed (IFC-104, IFC-105), 6 Backlog
    (IFC-006, IFC-007, IFC-011, IFC-107, IFC-128, IFC-136)
  - Sprint 3 is the current active sprint.
- Existing Framework: Framework.md v4.3 FINAL at
  `artifacts/sprint0/codex-run/Framework.md` governs strict mode, waivers,
  forbidden runtime paths, uniqueness.
- Canonical Sprint Plan:
  `apps/project-tracker/docs/metrics/_global/Sprint_plan.csv`
- Audit Matrix: `audit-matrix.yml` (repo root, full path:
  `C:\taly\intelliFlow-CRM\audit-matrix.yml`)
- Audit Waivers: `tools/audit/waivers/*.json` (waiver files for disabled
  required tools)

## Non-Negotiable Constraints

1. Do NOT move source-code files.
2. Implement enforcement using existing CSV columns (no new headers).
3. Windows compatible (PowerShell + Node/TS).
4. Deterministic: no multiple approaches, no questions.

## Strict Mode Configuration

- Environment variable: `VALIDATION_STRICT=1` (default: 0 / unset)
- Read by: `tools/scripts/sprint-validation.ts` and all validation utilities
- Effect: Converts all WARN results to FAIL (blocking)
- Usage: `VALIDATION_STRICT=1 pnpm run validate:sprint -- --sprint=3`

## Run ID Format

- Format: `YYYYMMDD-HHMMSS-<task_id>-<random_4_hex>`
- Example: `20251225-143022-IFC-006-a3f7`
- Generated by: orchestrator or validation script at run start
- Used in: context pack paths, transcript paths, deprecation plan paths

## Goal

Convert these CSV columns into a machine-enforceable execution contract:

- Pre-requisites => REQUIRED CONTEXT (files/dirs/env/policies) with parseable
  tags
- Artifacts To Track => REQUIRED EVIDENCE (context_pack, context_ack,
  transcripts)
- Validation Method => REQUIRED GATES (validate/audit tool IDs)

Also: propose a safe deprecation plan for CrossQuarterDeps and
CleanDependencies.

## Workstream: Sub-agents (Must Execute)

AGENT A — CSV Contract Spec Agent

- Define a strict grammar for tags inside Pre-requisites / Artifacts To Track /
  Validation Method.
- Tags (mandatory): Pre-requisites: FILE:, DIR:, ENV:, POLICY: Artifacts To
  Track: EVIDENCE: Validation Method: VALIDATE:, AUDIT:, GATE:
- Define "NOELLIPSIS" rule: if any contract field contains literal "..." it is
  invalid:
  - local default => WARN
  - strict/CI => FAIL

DoD:

- A doc section added to Framework.md or tools/docs explaining the grammar
  (short and unambiguous).
- A parser implementation spec (TypeScript) with examples.

AGENT B — Context Pack Builder Agent

- Implement a generator: build_context_pack(task_id, run_id)
  - Reads the task row from Sprint_plan.csv (canonical location:
    `apps/project-tracker/docs/metrics/_global/Sprint_plan.csv`).
  - Extracts FILE: prerequisites and embeds bounded excerpts into
    artifacts/context/<run_id>/<task_id>/context_pack.md
  - Writes a manifest with hashes: context_pack.manifest.json (sha256 for each
    file).
- Bounded size rules (hardcoded, not configurable):
  - Excerpt limit: 120 lines per file maximum
  - If file exceeds 120 lines: include first 60 lines + last 60 lines with "[...
    N lines omitted ...]" marker
  - Total context pack size: 50KB max (warn if exceeded, truncate oldest files
    first)

DoD:

- Context pack generation works for at least one Sprint 3 Backlog task (IFC-006
  or IFC-007).
- Artifacts written under artifacts/context/... only.

AGENT C — Context Ack Gatekeeper Agent

- Require agents to produce context_ack.json BEFORE code changes are accepted:
  - task_id, run_id
  - files_read[] with sha256
  - invariants_acknowledged[] (at least 5 items)
- Enforce:
  - If row's Artifacts To Track contains EVIDENCE:context_ack => missing/invalid
    ack => FAIL
  - Ack must include all FILE: prerequisites; hashes must match manifest.
- Integrate into existing orchestrator phases (where applicable) or into
  validation scripts used in CI.

DoD:

- A run fails deterministically when ack is missing or does not include required
  FILE: items.
- In strict mode, this gate is blocking.

AGENT D — Validation/Audit Integration Agent

- Update validators to:
  1. Parse the contract tags from CSV.
  2. Detect ellipsis placeholders "..." in contract fields and apply NOELLIPSIS
     rule.
  3. Produce a transcript artifact per run:
     artifacts/reports/contract/<run_id>/<task_id>/contract_transcript.json
- Validate "required reading" can be proven:
  - For tasks executed (or marked In Progress), context_pack + ack must exist.

DoD:

- CI strict job fails if contract is invalid or evidence is missing.
- Output includes explicit FAIL/WARN reasons with task IDs.

AGENT E — Column Deprecation Agent (no file change yet; produce plan +
generator)

- Implement a deterministic derivation:
  - derived.cross_quarter_deps computed in generated registry JSON, based on
    Target Sprint values.
- Convert CleanDependencies into generated-only:
  - treat Dependencies as authoring field
  - generate CleanDependencies automatically during registry build; warn if CSV
    CleanDependencies diverges.
- Do NOT remove columns yet; produce a migration plan and warnings.

DoD:

- artifacts/reports/deprecation/<run_id>/csv-deprecation-plan.md created with a
  three-step timeline: Step 1: warn-only (current sprint); Step 2: enforce (next
  sprint); Step 3: remove column from CSV (sprint+2).

## Implementation Details (Mandatory)

1. Canonical paths:
   - Sprint_plan.csv:
     `apps/project-tracker/docs/metrics/_global/Sprint_plan.csv`
   - Framework.md: `artifacts/sprint0/codex-run/Framework.md`
   - Audit Matrix: `C:\taly\intelliFlow-CRM\audit-matrix.yml`
   - Use the canonical Sprint_plan.csv path used by the tracker; enforce
     uniqueness (multiple copies => FAIL always).
2. Evidence location:
   - All new runtime outputs must go under artifacts/...
   - Context packs: artifacts/context/<run_id>/<task_id>/
   - Contract transcripts: artifacts/reports/contract/<run_id>/<task_id>/
   - Deprecation plans: artifacts/reports/deprecation/<run_id>/
3. Tests:
   - Add Vitest unit tests for tag parsing, ellipsis detection, ack
     verification, strict-mode escalation.

## Acceptance Criteria (Global DoD)

- Agents cannot pass a task run that requires EVIDENCE:context_ack without
  producing a valid context_ack.json.
- Any task row containing "..." in contract fields fails in CI strict mode.
- Validation/audit transcripts are produced under artifacts/reports/contract/...
- Deprecation plan exists and CleanDependencies normalization is owned by
  generator, not manual edits.

## Deliverables

- Code changes + tests + updated CI step(s)
- Updated Framework section describing the contract grammar
- Sample updated CSV rows (see "Sample CSV Rows" section below for IFC-006 and
  IFC-007)
- New validation gates integrated into sprint-validation.ts (Gate 9, Gate 10)
- context_pack builder implementation in tools/scripts/lib/
- context_ack schema and validator

## Validation Gates Reference

The following validation gates are currently implemented in
`tools/scripts/sprint-validation.ts`:

- Gate 0: Sprint Start Gate (prerequisite sprints complete)
- Gate 1: Baseline Structure
- Gate 2: Sprint Completion (CSV status only)
- Gate 3: Evidence Integrity (task JSON semantics)
- Gate 4: Docs Hygiene (no runtime artifacts)
- Gate 5: Metrics Tracked State (no untracked files)
- Gate 6: Canonical Uniqueness
- Gate 7: Root-Level Artifact Containment
- Gate 8: Audit Matrix Waivers

Current validation status (Sprint 0): PASS 35, WARN 0, FAIL 0

## Integration with Existing Gates (NEW)

New contract enforcement integrates as additional gates:

- Gate 9 (NEW): Contract Tag Parser
  - Validates FILE:, DIR:, ENV:, POLICY: tags in Pre-requisites column
  - Validates EVIDENCE: tags in Artifacts To Track column
  - Validates VALIDATE:, AUDIT:, GATE: tags in Validation Method column
  - Applies NOELLIPSIS rule to all contract fields
- Gate 10 (NEW): Context Ack Gate
  - Verifies context_ack.json exists for tasks with EVIDENCE:context_ack
  - Validates SHA256 hashes match context_pack.manifest.json
  - Confirms all FILE: prerequisites are acknowledged
- Gate 3 (EXTENDED): Evidence Integrity
  - Add check for context_pack + context_ack existence for In Progress/Completed
    tasks

## Sample CSV Rows (Contract Tags Applied)

These examples show how to add contract tags to Sprint 3 Backlog tasks:

IFC-006 (Supabase Integration Test):

```csv
Task ID,Pre-requisites,Artifacts To Track,Validation Method
IFC-006,"FILE:packages/db/prisma/schema.prisma;FILE:infra/supabase/config.toml;ENV:SUPABASE_URL;ENV:SUPABASE_ANON_KEY;POLICY:zero-trust-db-access","EVIDENCE:context_ack;EVIDENCE:test_output;EVIDENCE:integration_log","VALIDATE:pnpm test:integration;GATE:supabase-healthcheck;AUDIT:db-schema-drift"
```

IFC-007 (Performance Benchmarks):

```csv
Task ID,Pre-requisites,Artifacts To Track,Validation Method
IFC-007,"FILE:apps/api/src/modules/**/router.ts;FILE:vitest.config.ts;DIR:tests/integration;ENV:API_URL;POLICY:performance-budgets","EVIDENCE:context_ack;EVIDENCE:benchmark_results;EVIDENCE:flamegraph","VALIDATE:pnpm run benchmark;GATE:p95-latency-check;AUDIT:perf-regression"
```

END.
