{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://intelliflow-crm.com/schemas/task-status.schema.json",
  "title": "Task Status Schema",
  "description": "Schema for tracking individual task execution, artifacts, validations, and KPIs",
  "type": "object",
  "required": ["task_id", "status"],
  "properties": {
    "$schema": {
      "type": "string"
    },
    "task_id": {
      "type": "string",
      "pattern": "^[A-Z]+-[A-Z0-9-]+$",
      "description": "Unique task identifier (e.g., ENV-002-AI, EXC-SEC-001)"
    },
    "section": {
      "type": "string",
      "description": "Task category/section"
    },
    "description": {
      "type": "string",
      "description": "Brief description of the task"
    },
    "owner": {
      "type": "string",
      "description": "Task owner or responsible party"
    },
    "sprint": {
      "type": "string",
      "description": "Sprint identifier (e.g., sprint-0)"
    },
    "phase": {
      "type": "string",
      "description": "Phase within the sprint (e.g., phase-1-ai-foundation)"
    },
    "stream": {
      "type": ["string", "null"],
      "description": "Parallel stream identifier (e.g., parallel-a, parallel-b, parallel-c)"
    },
    "dependencies": {
      "type": "object",
      "required": ["required", "all_satisfied"],
      "properties": {
        "required": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of prerequisite task IDs"
        },
        "verified_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "ISO 8601 timestamp when dependencies were verified (null if not yet verified)"
        },
        "all_satisfied": {
          "type": "boolean",
          "description": "Whether all dependencies are satisfied"
        },
        "notes": {
          "type": "string",
          "description": "Additional notes about dependency status"
        }
      }
    },
    "dependencies_resolved": {
      "type": "array",
      "items": { "type": "string" },
      "description": "List of resolved dependency task IDs (legacy compatibility)"
    },
    "status": {
      "type": "string",
      "enum": [
        "PLANNED",
        "Planned",
        "BACKLOG",
        "Backlog",
        "IN_PROGRESS",
        "In Progress",
        "VALIDATING",
        "Validating",
        "DONE",
        "Completed",
        "BLOCKED",
        "Blocked",
        "FAILED",
        "Failed",
        "NEEDS_HUMAN",
        "Needs Human",
        "IN_REVIEW",
        "In Review"
      ],
      "description": "Current task status"
    },
    "started_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO 8601 timestamp when task execution started (null if not started)"
    },
    "completed_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO 8601 timestamp when task was completed (null if not completed)"
    },
    "target_duration_minutes": {
      "type": ["number", "null"],
      "description": "Expected duration in minutes"
    },
    "actual_duration_minutes": {
      "type": ["number", "null"],
      "description": "Actual duration in minutes"
    },
    "status_history": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["status", "at"],
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "PLANNED",
              "Planned",
              "BACKLOG",
              "Backlog",
              "IN_PROGRESS",
              "In Progress",
              "VALIDATING",
              "Validating",
              "DONE",
              "Completed",
              "BLOCKED",
              "Blocked",
              "FAILED",
              "Failed",
              "NEEDS_HUMAN",
              "Needs Human",
              "IN_REVIEW",
              "In Review"
            ]
          },
          "at": {
            "type": "string",
            "format": "date-time"
          },
          "note": {
            "type": "string"
          }
        }
      },
      "description": "Chronological history of status changes"
    },
    "execution": {
      "type": "object",
      "properties": {
        "started_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When execution started (null if not started)"
        },
        "completed_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When execution completed (null if not completed)"
        },
        "duration_minutes": {
          "type": ["number", "null"],
          "description": "Execution duration in minutes"
        },
        "executor": {
          "type": "string",
          "description": "Who/what executed the task (human, agent, etc.)"
        },
        "agents": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of AI agents involved in execution"
        },
        "execution_log": {
          "type": "string",
          "description": "Path to detailed execution log file"
        },
        "log_path": {
          "type": "string",
          "description": "Alternative path to execution log (alias for execution_log)"
        },
        "retry_count": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Number of retry attempts"
        },
        "last_error": {
          "type": ["string", "null"],
          "description": "Last error message if task failed (null if no error)"
        }
      }
    },
    "artifacts": {
      "type": "object",
      "properties": {
        "expected": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of expected file paths or patterns"
        },
        "created": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "sha256", "created_at"],
            "properties": {
              "path": {
                "type": "string"
              },
              "sha256": {
                "type": "string",
                "pattern": "^[a-f0-9]{64}$"
              },
              "created_at": {
                "type": "string",
                "format": "date-time"
              }
            }
          },
          "description": "Artifacts actually created with verification hashes"
        },
        "missing": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Expected artifacts that were not created"
        }
      }
    },
    "validations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "command", "executed_at", "exit_code", "passed"],
        "properties": {
          "name": {
            "type": "string"
          },
          "command": {
            "type": "string"
          },
          "executed_at": {
            "type": "string",
            "format": "date-time"
          },
          "exit_code": {
            "type": "integer"
          },
          "duration_ms": {
            "type": "integer"
          },
          "stdout_hash": {
            "type": "string",
            "description": "SHA256 hash of stdout for verification"
          },
          "passed": {
            "type": "boolean"
          }
        }
      },
      "description": "Validation commands executed to verify task completion"
    },
    "kpis": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["target", "actual", "met"],
        "properties": {
          "target": {
            "description": "Target value for the KPI"
          },
          "actual": {
            "description": "Actual measured value"
          },
          "met": {
            "type": "boolean",
            "description": "Whether target was met"
          },
          "unit": {
            "type": "string"
          }
        }
      },
      "description": "Key Performance Indicators for this task"
    },
    "blockers": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["description", "raised_at"],
        "properties": {
          "description": {
            "type": "string"
          },
          "raised_at": {
            "type": "string",
            "format": "date-time"
          },
          "resolved_at": {
            "type": ["string", "null"],
            "format": "date-time"
          },
          "resolution": {
            "type": "string"
          }
        }
      },
      "description": "Any blockers encountered during task execution"
    },
    "notes": {
      "type": "string",
      "description": "Additional notes or context"
    }
  }
}
