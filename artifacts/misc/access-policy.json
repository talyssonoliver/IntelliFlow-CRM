{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "title": "IntelliFlow CRM Vault Access Policies",
  "description": "Access control policies for HashiCorp Vault secrets management",
  "version": "1.0.0",
  "policies": [
    {
      "name": "api-service-policy",
      "description": "Policy for tRPC API service to access database credentials and API keys",
      "path": "api-service",
      "rules": [
        {
          "path": "secret/data/database/*",
          "capabilities": ["read", "list"]
        },
        {
          "path": "secret/data/api-keys/external/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/jwt/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/encryption/*",
          "capabilities": ["read"]
        }
      ]
    },
    {
      "name": "ai-worker-policy",
      "description": "Policy for AI worker to access LLM API keys and embeddings credentials",
      "path": "ai-worker",
      "rules": [
        {
          "path": "secret/data/openai/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/ollama/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/langchain/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/database/readonly",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/redis/*",
          "capabilities": ["read"]
        }
      ]
    },
    {
      "name": "web-app-policy",
      "description": "Policy for Next.js web application (minimal access)",
      "path": "web-app",
      "rules": [
        {
          "path": "secret/data/nextauth/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/session/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/analytics/*",
          "capabilities": ["read"]
        }
      ]
    },
    {
      "name": "database-admin-policy",
      "description": "Policy for database administrators (elevated access)",
      "path": "database-admin",
      "rules": [
        {
          "path": "secret/data/database/*",
          "capabilities": ["create", "read", "update", "delete", "list"]
        },
        {
          "path": "secret/metadata/database/*",
          "capabilities": ["read", "list", "delete"]
        }
      ]
    },
    {
      "name": "ci-cd-policy",
      "description": "Policy for CI/CD pipelines (deployment secrets)",
      "path": "ci-cd",
      "rules": [
        {
          "path": "secret/data/deployment/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/registry/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/kubernetes/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/terraform/*",
          "capabilities": ["read"]
        }
      ]
    },
    {
      "name": "monitoring-policy",
      "description": "Policy for monitoring services (Sentry, OpenTelemetry, etc.)",
      "path": "monitoring",
      "rules": [
        {
          "path": "secret/data/sentry/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/grafana/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/prometheus/*",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/pagerduty/*",
          "capabilities": ["read"]
        }
      ]
    },
    {
      "name": "supabase-integration-policy",
      "description": "Policy for Supabase integration (database, auth, storage)",
      "path": "supabase",
      "rules": [
        {
          "path": "secret/data/supabase/anon-key",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/supabase/service-role-key",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/supabase/jwt-secret",
          "capabilities": ["read"]
        },
        {
          "path": "secret/data/supabase/db-url",
          "capabilities": ["read"]
        }
      ]
    },
    {
      "name": "admin-policy",
      "description": "Full administrative access (emergency use only)",
      "path": "admin",
      "rules": [
        {
          "path": "secret/*",
          "capabilities": ["create", "read", "update", "delete", "list"]
        },
        {
          "path": "sys/policies/acl/*",
          "capabilities": ["create", "read", "update", "delete", "list"]
        },
        {
          "path": "sys/auth/*",
          "capabilities": ["create", "read", "update", "delete", "list"]
        },
        {
          "path": "sys/audit/*",
          "capabilities": ["create", "read", "update", "delete", "list"]
        }
      ]
    }
  ],
  "authMethods": [
    {
      "type": "kubernetes",
      "path": "kubernetes",
      "description": "Kubernetes service account authentication",
      "config": {
        "kubernetes_host": "https://kubernetes.default.svc",
        "kubernetes_ca_cert": "@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt",
        "token_reviewer_jwt": "@/var/run/secrets/kubernetes.io/serviceaccount/token"
      }
    },
    {
      "type": "approle",
      "path": "approle",
      "description": "AppRole authentication for services",
      "config": {
        "bind_secret_id": true,
        "token_ttl": "1h",
        "token_max_ttl": "24h"
      }
    },
    {
      "type": "github",
      "path": "github",
      "description": "GitHub authentication for developers",
      "config": {
        "organization": "intelliflow-crm",
        "base_url": "https://api.github.com"
      }
    }
  ],
  "secretEngines": [
    {
      "type": "kv-v2",
      "path": "secret",
      "description": "Key-Value secrets engine (version 2)",
      "config": {
        "max_versions": 10,
        "cas_required": false,
        "delete_version_after": "0s"
      }
    },
    {
      "type": "database",
      "path": "database",
      "description": "Dynamic database credentials",
      "config": {
        "plugin_name": "postgresql-database-plugin",
        "allowed_roles": ["api-service", "ai-worker", "readonly"],
        "connection_url": "postgresql://{{username}}:{{password}}@postgres:5432/intelliflow?sslmode=require",
        "max_open_connections": 5,
        "max_idle_connections": 0,
        "max_connection_lifetime": "1h"
      }
    },
    {
      "type": "transit",
      "path": "transit",
      "description": "Encryption as a Service",
      "config": {
        "type": "aes256-gcm96",
        "exportable": false,
        "allow_plaintext_backup": false
      }
    }
  ],
  "auditDevices": [
    {
      "type": "file",
      "path": "file",
      "description": "File-based audit logging",
      "options": {
        "file_path": "/vault/logs/audit.log",
        "log_raw": false,
        "hmac_accessor": true,
        "mode": "0600",
        "format": "json"
      }
    }
  ],
  "rotationPolicies": {
    "database_credentials": {
      "rotation_period": "30d",
      "description": "Rotate database credentials monthly"
    },
    "api_keys": {
      "rotation_period": "90d",
      "description": "Rotate external API keys quarterly"
    },
    "jwt_secrets": {
      "rotation_period": "180d",
      "description": "Rotate JWT signing secrets bi-annually"
    }
  },
  "metadata": {
    "created_by": "DevOps Team",
    "last_updated": "2025-12-14",
    "environment": "production",
    "compliance": ["SOC2", "GDPR", "HIPAA"]
  }
}
