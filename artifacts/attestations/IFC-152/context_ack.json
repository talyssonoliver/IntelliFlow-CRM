{
  "task_id": "IFC-152",
  "task_name": "Case document model: storage metadata, versioning, ACL mapping (tenant + case + role), and audit hooks",
  "sprint": 11,
  "section": "Case Docs",
  "owner": "Backend Dev + Domain Architect (STOA-Intelligence)",
  "acknowledged_at": "2025-12-29T23:43:00Z",
  "prerequisites_verified": {
    "constitution": {
      "file": ".specify/memory/constitution.md",
      "verified": true,
      "key_requirements": [
        "Domain-Driven Design with value objects",
        "Repository pattern for data access",
        "Prisma ORM with PostgreSQL",
        "tRPC for type-safe API endpoints"
      ]
    },
    "dependencies": {
      "IFC-136": {
        "status": "DONE",
        "description": "Case management domain model"
      },
      "IFC-127": {
        "status": "DONE",
        "description": "Audit logging infrastructure"
      },
      "IFC-094": {
        "status": "DONE",
        "description": "Document management foundations"
      }
    },
    "files_read": [
      "packages/db/prisma/schema.prisma",
      "docs/planning/adr/ADR-004-multi-tenancy.md"
    ]
  },
  "implementation_approach": {
    "domain_model": {
      "file": "packages/domain/src/legal/cases/case-document.ts",
      "components": [
        "CaseDocument aggregate root",
        "Version value object",
        "ACL mapping (tenant + case + role)",
        "Audit hooks for create/update/delete events"
      ]
    },
    "database_migration": {
      "file": "packages/db/prisma/case-document.sql",
      "schema_changes": [
        "case_documents table with versioning",
        "document_versions table for history",
        "document_acl table for permissions",
        "Audit triggers for all operations"
      ]
    },
    "api_router": {
      "file": "apps/api/src/modules/crm/documents.router.ts",
      "endpoints": [
        "create: Upload document",
        "get: Retrieve document (ACL checked)",
        "update: New version",
        "delete: Soft delete with audit",
        "listVersions: Get version history"
      ]
    },
    "testing_strategy": "pnpm test with repository pattern tests"
  },
  "artifacts_to_create": [
    "packages/domain/src/legal/cases/case-document.ts",
    "packages/db/prisma/case-document.sql",
    "apps/api/src/modules/crm/documents.router.ts",
    "artifacts/attestations/IFC-152/context_ack.json"
  ]
}
