// IntelliFlow CRM - Prisma Schema
// This schema is AI-optimized with pgvector for embeddings

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector, uuid_ossp]
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  leads         Lead[]
  contacts      Contact[]
  accounts      Account[]
  opportunities Opportunity[]
  tasks         Task[]
  aiScores      AIScore[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  MANAGER
  SALES_REP
}

// ============================================
// CRM CORE ENTITIES
// ============================================

model Lead {
  id            String      @id @default(cuid())
  email         String
  firstName     String?
  lastName      String?
  company       String?
  title         String?
  phone         String?
  source        LeadSource  @default(WEBSITE)
  status        LeadStatus  @default(NEW)
  score         Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  ownerId       String
  owner         User        @relation(fields: [ownerId], references: [id])
  contact       Contact?
  aiScores      AIScore[]
  tasks         Task[]

  // AI Embedding for semantic search
  embedding     Unsupported("vector(1536)")?

  @@index([email])
  @@index([status])
  @@index([score])
  @@index([ownerId])
  @@index([createdAt])
  @@map("leads")
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL
  EMAIL
  COLD_CALL
  EVENT
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
  CONVERTED
  LOST
}

model Contact {
  id            String    @id @default(cuid())
  email         String    @unique
  firstName     String
  lastName      String
  title         String?
  phone         String?
  department    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id])
  accountId     String?
  account       Account?  @relation(fields: [accountId], references: [id])
  leadId        String?   @unique
  lead          Lead?     @relation(fields: [leadId], references: [id])
  opportunities Opportunity[]
  tasks         Task[]

  // AI Embedding
  embedding     Unsupported("vector(1536)")?

  @@index([email])
  @@index([ownerId])
  @@index([accountId])
  @@map("contacts")
}

model Account {
  id            String    @id @default(cuid())
  name          String
  website       String?
  industry      String?
  employees     Int?
  revenue       Decimal?  @db.Decimal(15, 2)
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id])
  contacts      Contact[]
  opportunities Opportunity[]

  @@index([name])
  @@index([ownerId])
  @@map("accounts")
}

model Opportunity {
  id            String              @id @default(cuid())
  name          String
  value         Decimal             @db.Decimal(15, 2)
  stage         OpportunityStage    @default(PROSPECTING)
  probability   Int                 @default(0)
  expectedCloseDate DateTime?
  description   String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  closedAt      DateTime?

  // Relations
  ownerId       String
  owner         User                @relation(fields: [ownerId], references: [id])
  accountId     String
  account       Account             @relation(fields: [accountId], references: [id])
  contactId     String?
  contact       Contact?            @relation(fields: [contactId], references: [id])
  tasks         Task[]

  @@index([stage])
  @@index([ownerId])
  @@index([accountId])
  @@index([expectedCloseDate])
  @@map("opportunities")
}

enum OpportunityStage {
  PROSPECTING
  QUALIFICATION
  NEEDS_ANALYSIS
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

model Task {
  id            String      @id @default(cuid())
  title         String
  description   String?
  dueDate       DateTime?
  priority      TaskPriority @default(MEDIUM)
  status        TaskStatus  @default(PENDING)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  completedAt   DateTime?

  // Relations
  ownerId       String
  owner         User        @relation(fields: [ownerId], references: [id])
  leadId        String?
  lead          Lead?       @relation(fields: [leadId], references: [id])
  contactId     String?
  contact       Contact?    @relation(fields: [contactId], references: [id])
  opportunityId String?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])

  @@index([status])
  @@index([ownerId])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// AI & INTELLIGENCE
// ============================================

model AIScore {
  id            String    @id @default(cuid())
  score         Int
  confidence    Float
  factors       Json      // Scoring factors breakdown
  modelVersion  String
  createdAt     DateTime  @default(now())

  // Relations
  leadId        String
  lead          Lead      @relation(fields: [leadId], references: [id])
  scoredById    String
  scoredBy      User      @relation(fields: [scoredById], references: [id])

  @@index([leadId])
  @@index([createdAt])
  @@map("ai_scores")
}

// ============================================
// AUDIT & EVENTS
// ============================================

model AuditLog {
  id            String    @id @default(cuid())
  action        String
  entityType    String
  entityId      String
  oldValue      Json?
  newValue      Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())

  // Relations
  userId        String
  user          User      @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model DomainEvent {
  id            String    @id @default(cuid())
  eventType     String
  aggregateType String
  aggregateId   String
  payload       Json
  metadata      Json?
  occurredAt    DateTime  @default(now())
  processedAt   DateTime?
  status        EventStatus @default(PENDING)

  @@index([eventType])
  @@index([aggregateType, aggregateId])
  @@index([status])
  @@index([occurredAt])
  @@map("domain_events")
}

enum EventStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

// ============================================
// LEGAL DOMAIN - APPOINTMENTS
// ============================================

model Appointment {
  id                  String              @id @default(cuid())
  title               String
  description         String?
  startTime           DateTime
  endTime             DateTime
  appointmentType     AppointmentType     @default(MEETING)
  status              AppointmentStatus   @default(SCHEDULED)
  location            String?
  notes               String?

  // Buffer times
  bufferMinutesBefore Int                 @default(0)
  bufferMinutesAfter  Int                 @default(0)

  // Recurrence (stored as JSON)
  recurrence          Json?
  parentAppointmentId String?
  parentAppointment   Appointment?        @relation("RecurringSeries", fields: [parentAppointmentId], references: [id])
  recurringInstances  Appointment[]       @relation("RecurringSeries")

  // External calendar integration
  externalCalendarId  String?

  // Reminder
  reminderMinutes     Int?

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  cancelledAt         DateTime?
  completedAt         DateTime?
  cancellationReason  String?

  // Relations
  organizerId         String
  attendees           AppointmentAttendee[]
  linkedCases         AppointmentCase[]

  @@index([organizerId])
  @@index([status])
  @@index([startTime])
  @@index([endTime])
  @@index([appointmentType])
  @@index([startTime, endTime])
  @@index([externalCalendarId])
  @@map("appointments")
}

model AppointmentAttendee {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  userId        String
  createdAt     DateTime    @default(now())

  @@unique([appointmentId, userId])
  @@index([userId])
  @@map("appointment_attendees")
}

model AppointmentCase {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  caseId        String
  createdAt     DateTime    @default(now())

  @@unique([appointmentId, caseId])
  @@index([caseId])
  @@map("appointment_cases")
}

enum AppointmentType {
  MEETING
  CALL
  HEARING
  CONSULTATION
  DEPOSITION
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================
// SECURITY EVENTS - IFC-098 RBAC/ABAC
// ============================================

model SecurityEvent {
  id              String          @id @default(cuid())
  eventType       String          // login, logout, permission_denied, role_change, etc.
  severity        SecuritySeverity @default(INFO)

  // Actor
  actorId         String?
  actorEmail      String?
  actorIp         String?

  // Event details
  description     String?
  details         Json?

  // Detection flags
  detected        Boolean         @default(false)
  detectedBy      String?
  blocked         Boolean         @default(false)
  alertSent       Boolean         @default(false)

  // Timestamps
  createdAt       DateTime        @default(now())

  @@index([eventType])
  @@index([actorId])
  @@index([severity])
  @@index([createdAt])
  @@map("security_events")
}

enum SecuritySeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EventOutcome {
  SUCCESS
  FAILURE
  DENIED
  ERROR
}

// ============================================
// TICKETS & SLA TRACKING - IFC-093
// ============================================

model Ticket {
  id                  String          @id @default(cuid())
  ticketNumber        String          @unique // T-XXXXX format
  subject             String
  description         String?
  status              TicketStatus    @default(OPEN)
  priority            TicketPriority  @default(MEDIUM)

  // SLA Tracking
  slaPolicy           SLAPolicy       @relation(fields: [slaPolicyId], references: [id])
  slaPolicyId         String
  slaResponseDue      DateTime?       // First response due time
  slaResolutionDue    DateTime?       // Resolution due time
  slaStatus           SLAStatus       @default(ON_TRACK)
  slaBreachedAt       DateTime?       // When SLA was first breached
  firstResponseAt     DateTime?       // When first response was made
  resolvedAt          DateTime?       // When ticket was resolved

  // Contact & Assignment
  contactId           String?
  contactName         String
  contactEmail        String
  assigneeId          String?

  // Timestamps
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  closedAt            DateTime?

  // Notifications
  slaNotifications    SLANotification[]

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([slaStatus])
  @@index([assigneeId])
  @@index([contactId])
  @@index([slaResolutionDue])
  @@map("tickets")
}

model SLAPolicy {
  id                      String        @id @default(cuid())
  name                    String
  description             String?

  // Response time SLAs in minutes
  criticalResponseMinutes Int           @default(15)
  highResponseMinutes     Int           @default(60)
  mediumResponseMinutes   Int           @default(240)  // 4 hours
  lowResponseMinutes      Int           @default(480)  // 8 hours

  // Resolution time SLAs in minutes
  criticalResolutionMinutes Int         @default(120)  // 2 hours
  highResolutionMinutes     Int         @default(480)  // 8 hours
  mediumResolutionMinutes   Int         @default(1440) // 24 hours
  lowResolutionMinutes      Int         @default(4320) // 72 hours

  // Warning thresholds (percentage of time remaining)
  warningThresholdPercent Int           @default(25)   // Warn at 25% remaining

  isDefault               Boolean       @default(false)
  isActive                Boolean       @default(true)

  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  tickets                 Ticket[]

  @@map("sla_policies")
}

model SLANotification {
  id              String                @id @default(cuid())
  ticketId        String
  ticket          Ticket                @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type            SLANotificationType
  severity        SLANotificationSeverity @default(INFO)
  message         String
  sentAt          DateTime              @default(now())
  acknowledgedAt  DateTime?
  acknowledgedBy  String?

  @@index([ticketId])
  @@index([type])
  @@index([sentAt])
  @@map("sla_notifications")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_THIRD_PARTY
  RESOLVED
  CLOSED
}

enum TicketPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum SLAStatus {
  ON_TRACK       // Within SLA, plenty of time
  AT_RISK        // Getting close to breach (warning threshold)
  BREACHED       // SLA has been breached
  PAUSED         // SLA timer paused (waiting on customer)
  MET            // SLA was met (resolved in time)
}

enum SLANotificationType {
  WARNING          // Approaching SLA breach
  BREACH           // SLA has been breached
  ESCALATION       // Ticket has been escalated
  ASSIGNMENT       // Ticket has been assigned
  RESOLUTION       // Ticket has been resolved
}

enum SLANotificationSeverity {
  INFO
  WARNING
  CRITICAL
}
